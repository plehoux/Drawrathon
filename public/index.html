<!doctype html>
<html>
	<head>
		<title>Drawrathon</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
		<script src="client/socket.io.js" type="text/javascript"></script>
		<script src="js/json.js" type="text/javascript"></script>
		<script src="js/underscore.js" type="text/javascript"></script>
		<style>
			body {margin:0px;
			}
			#title {
				position:absolute;
				width:100px;
				top:30px;
				left:80px;
			}
			
			#board {
			}
			
			#panel {
				position:absolute;
				width:255px;
				height:485px;
				min-height:250px;
				padding:15px;
				top:30px;
				right:10px;
				background-color:#000000;
				border-radius:8px;
				-moz-border-radius:8px;
			}
			
			#panel h2 {
				color:#ffffff;
				margin:0px;
			}
			
    	</style>
		<script>
		//alert(_.any([1,2,3,4,0], function(num){ return num == 0; }));
			io.setPath('client/');
			var socket = new io.Socket(null, {port: 8080});
			io.Socket.prototype.sendData = function(type,data) {
				dataObject = {
					type : type,
					data : data
					};
				this.send(JSON.stringify(dataObject));
			};
			
			socket.connect();
			
			function panel(panel) {

				this.panel = panel;
				this.panel.height($(document).height()*80/100);
				
				this.screenResize = function(){
					this.panel.height($(window).height()*80/100);
				}
				
			}
			
			function draw(canevas,socket){
				this.canevas = canevas;

			
				this.socket = socket;
				if(this.canevas[0].getContext){
					
					this.ctx = this.canevas[0].getContext("2d");
					

					this.drawing = false;
					
					this.points = [];
					this.pointsTemp = [];
					
					this.canevas[0].height = ($(document).height()-6);
					this.canevas[0].width = $(document).width();
					

					this.canevas.bind('mousedown',this,function(e){
							e.data.drawDown(e.pageX,e.pageY);
					});
					
					this.canevas.bind('mousemove',this,function(e){
						e.data.drawMove(e.pageX,e.pageY);
					});
					
					this.canevas.bind('mouseup',this,function(e){
								e.data.drawUp();
					});
					
				}else{
					return false;
				}
								
				this.drawDown = function drawDown(x,y) {
					if(!this.drawing){
						this.drawing = true;
						this.ctx.lineWidth = 1;
						this.ctx.beginPath();
						this.ctx.moveTo(x-this.canevas.offset().left,y-this.canevas.offset().top);
						this.pointsTemp = [];
						this.pointsTemp.push({x:x-this.canevas.offset().left,y:y-this.canevas.offset().top,s:true});
					}
				}
				
				this.drawMove = function drawMove(x,y) {
					if(this.drawing){
						this.ctx.lineTo(x-this.canevas.offset().left,y-this.canevas.offset().top);
						this.ctx.stroke();
						this.pointsTemp.push({x:x-this.canevas.offset().left,y:y-this.canevas.offset().top,s:false});
						if(this.pointsTemp.length > 2) {
							this.socket.sendData('drawingData',this.pointsTemp);
							$.merge(this.points,this.pointsTemp);
							this.pointsTemp = [];
						}
					}
				}
				
				this.drawUp = function drawUp(){
					this.drawing = false;
					$.merge(this.points,this.pointsTemp);
					this.socket.sendData('drawingData',this.pointsTemp);
				}
				
				this.drawArray = function drawArray(points){
					for(var i=0;i<points.length;i++) {
						if(points[i].s){
							
							this.ctx.beginPath();
							this.ctx.moveTo(points[i].x-this.canevas.offset().left,points[i].y-this.canevas.offset().top);
						} else {
							this.ctx.lineTo(points[i].x-this.canevas.offset().left,points[i].y-this.canevas.offset().top);
							this.ctx.stroke();
						}
					}
				}
				
				
				this.screenResize = function screenResize() {
				
					this.canevas[0].height = ($(window).height()-5);
					this.canevas[0].width = $(window).width();
					this.drawArray(this.points);
				
				}
				
				this.del = function(){
					this.points = [];
					this.ctx.clearRect(0,0,this.canevas.width(),this.canevas.height());
				}
			}

			$(document).ready(function(){
			
				FB.init({ apiKey: '41498240faa11983d28cc4504b952284' });
				
				FB.getLoginStatus(handleSessionResponse);
				
				$('#login').click(function(){
					FB.login(handleSessionResponse);
				});
				
				
				function handleSessionResponse(response){
				
					if(!response.session) {
					
					}
					
					FB.api({
						method:'fql.query',
						query: 'SELECT name,id FROM profile WHERE id=' + FB.getSession().uid
						},
						function(response){
							var user = response[0];
							$('#login').hide();
							$('#user').html('<h2>' + user.name + '</h2>');
							socket.sendData('userConnect',user.id);
						}
					);
					
				};
				
				var drawObject = new draw($("#board"),socket);
				var panelObject = new panel($("#panel"));
				
				socket.addEvent('message', function(data){
					
					data = JSON.parse(data);
					switch(data.type) {
						case 'drawingData':
							if(drawObject){
								drawObject.drawArray(data.data);
								$.merge(drawObject.points,data.data);
							}
						break
					}
				
				});
				
				socket.addEvent('disconnect', function(data){
				});
				
				socket.addEvent('connect', function(data){
				});
				
				$(window).resize(function() {
					drawObject.screenResize();
					panelObject.screenResize();
				});
				
				$(document).keyup(function(e){
					switch(e.which) {
						case 32:
							drawObject.del();	
						break
					}
				});
					
			});

		</script>
	</head>
	<body>
	<div id="fb-root"></div>
		<script src="http://connect.facebook.net/en_US/all.js"></script>
		
		<h1 id="title">Drawrathon</h1>
		<div id="panel">
			<div id="user">
				<button id="login">Login</button>
			</div>
			<div id="players">
				<div class="player"></div>
			</div>
		</div>
		<canvas id="board">	
		</canvas>

		
	</body>
</html>